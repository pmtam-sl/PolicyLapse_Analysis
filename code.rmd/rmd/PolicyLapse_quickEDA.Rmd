---
title: "Policy Lapse with TidyMode"
author: "Tam Pham"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE,
                      message = FALSE, echo = TRUE, dpi = 180,
                      fig.width = 8, fig.height = 5,
                      digits = 3)

library(tidyverse)
```

## Explore Data

```{r include=FALSE}
policy <-
readxl::read_xlsx("~/OneDrive/Learning/R for Data Science/Insurance_practices/data/PolicyLapse.xlsx")

policy <- 
  policy %>%
  janitor::remove_empty("cols") %>%
#  select(!where(is.logical),-c("PaymentTerm0","DistributionChannel0","PolicyYear")) %>%
  select(-c("PaymentTerm0","DistributionChannel0","PolicyYear")) %>%
  mutate_if(is.character,factor) %>%
  mutate(Lapsed = fct_rev(Lapsed))
```

**Summary policy data:**

```{r skim, echo=FALSE}
library(skimr)
my_skim <- skim_with(factor=sfl(pct = ~{
      prt <- sort(prop.table(table(.)), decreasing = TRUE)
      val <- sprintf("%.2f", prt)
      nm1 <- substr(names(prt), 1, 3)
      stringr::str_c(nm1, val, sep = ": ", collapse = ", ")
      })
)
my_skim(policy)
```

Overall, we can see:

-   32% of policy is lapsed. *Lapsed* is the outcome variable for our study.

-   53% of policy owner are male, similar to 52% of insured person are male.

-   14% of PO is also insured person.

-   PO age range from 22 to 59 with average age 43.3. And the age of insured person range from 18-64 with average of 40.

-   We also found some missing value in Number Of Emails, Calls, Claims and Phone registered information.

## Quick EDA

### For Categorical variables {.tabset}
#### Gender
**Is the likelihood of lapse dependent on gender** 

```{r include=FALSE, eval=FALSE}
d.policy <-
policy %>%
  filter(Lapsed == "Lapsed") %>%
  select(where(is.factor))

d.policy %>%
  count(Lapsed,PO_Sex)
```

```{r echo=FALSE}
gg.PO_Sex <-
policy %>%
  count(Lapsed,PO_Sex) %>%
  group_by(PO_Sex) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(PO_Sex, percent, fill=PO_Sex)) +
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge") +
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent),vjust = 2)) +
  labs(x="", title = "Lapsed by PO Gender") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0,0.37))

gg.INS_Sex <-
policy %>%
  count(Lapsed,INS_Sex) %>%
  group_by(INS_Sex) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(INS_Sex, percent, fill=INS_Sex)) +
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge") +
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent),vjust = 2)) +
  labs(x="", title = "Lapsed by INS Gender") +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0,0.37))

ggpubr::ggarrange(gg.PO_Sex,gg.INS_Sex,
                  ncol = 2, nrow = 1) 
```

```{r include=FALSE, echo=FALSE}
# Kiem tra them
table(policy$Lapsed,policy$PO_Sex,
      dnn=c("Lapsed","PO_Sex")) %>%
  prop.table(2) %>% 
  as.data.frame() %>%
  filter(Lapsed =="TRUE") %>% 
  ggplot(aes(x=PO_Sex,y=Freq,fill=PO_Sex)) + geom_col()
```

#### Occupation
**Could it be the Occupation Class correlated with the probability of Lapse**

```{r echo=FALSE}
policy %>%
  count(Lapsed, Occupation) %>%
  group_by(Occupation) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(x=Occupation, y=percent, fill=Occupation)) +
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge") +
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent),vjust = 2)) +
  labs(x="", title = "Lapsed by Occupation Group") +
  scale_y_continuous(labels = scales::percent_format())
```

#### Occupation and Gender

**Does the higher lapse rate in Occupation Group 1 have any correlation with gender distribution in which male clients dominate?**

```{r echo=FALSE}
policy %>%
  group_by(Occupation, PO_Sex, Lapsed, ) %>%
  summarise(n = n()) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(x=Occupation,y=percent, fill=PO_Sex)) +
  geom_bar(stat = "identity",
           position = "dodge", alpha=0.7 ) +
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent)),
            position=position_dodge(width=0.9), vjust=2)+
  labs(title = "Lapsed by Occupation Group and PO Gender") +
  scale_y_continuous(labels = scales::percent_format())
```

#### Others
**What is the Lapsed rate with other categorical variables: Distribution Channel, Payment Term, PO is INSURRED**

```{r echo=FALSE}
gg.PO_is_INS <-
  policy %>%
  count(Lapsed, PO_is_INS) %>%
  group_by(PO_is_INS) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(PO_is_INS,percent, fill=PO_is_INS))+
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge")+
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent)),
            position=position_dodge(width=0.9), vjust=2)+
  labs(x="",title = "Lapsed by PO is also INS person") +
  scale_y_continuous(labels = scales::percent_format())

gg.Payment <- 
  policy %>%
  count(Lapsed, PaymentTerm) %>%
  group_by(PaymentTerm) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(fct_reorder(PaymentTerm,percent),percent, fill=PaymentTerm))+
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge")+
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent)),
            position=position_dodge(width=0.9), vjust=2)+
  labs(x="",title = "Lapsed by Payment Term") +
  scale_y_continuous(labels = scales::percent_format())

gg.Distribution <-
  policy %>%
  count(Lapsed, DistributionChannel) %>%
  group_by(DistributionChannel) %>%
  mutate(percent = n/sum(n)) %>%
  filter(Lapsed) %>%
  ggplot(aes(fct_reorder(DistributionChannel,percent),percent, fill=DistributionChannel))+
  geom_col(alpha = 0.7, show.legend = FALSE, position = "dodge")+
  geom_text(aes(label=sprintf("%1.1f%%", 100*percent)),
            position=position_dodge(width=0.9), vjust=2)+
  labs(x="",title = "Lapsed by Distribution Channel") +
  scale_y_continuous(labels = scales::percent_format())

ggpubr::ggarrange(gg.Payment,gg.Distribution,gg.PO_is_INS,
                  ncol = 2, nrow = 2)
```

### {.tabset}
#### Client Interaction

#### Client Interaction vs Policy Events

```{r}
policy %>%
  select(Lapsed, NumOfReinstated, NumOfClaims, NumOfCalls) %>%
  group_by(NumOfCalls, NumOfReinstated, NumOfClaims) %>%
  summarise(Lapsed = mean(Lapsed)) %>%
  ungroup() %>% 
  na.omit() %>%
  ggplot(aes(x=NumOfCalls, y=Lapsed)) +
  geom_line()+
  facet_grid(NumOfClaims ~NumOfReinstated) 
#scale_y_continuous(labels = scales::label_number(format(sub('^(-)?0[.]', '\\1.')))
```

```{r}
policy %>%
  select(Lapsed, NumOfReinstated, NumOfClaims, NumOfEmails) %>%
  group_by(NumOfEmails, NumOfReinstated, NumOfClaims) %>%
  summarise(Lapsed = mean(Lapsed)) %>%
  ungroup() %>% 
  na.omit() %>%
  ggplot(aes(x=NumOfEmails, y=Lapsed)) +
  geom_line()+
  facet_grid(NumOfClaims ~NumOfReinstated)
```

#### Age

```{r Age_density}
policy %>%
  ggplot(aes(PO_Age, fill=PO_Sex)) +
  geom_density(alpha=0.6) + 
  theme_light(base_size = 10)
```

```{r}
policy %>% 
  ggplot(aes(PO_Age, Lapsed = mean(Lapsed), fill=PO_Sex)) +
  geom_histogram(bins = 8, alpha = 0.6, show.legend = FALSE)+
  facet_grid(PO_Sex ~ Lapsed)
```

### Correlation check

```{r}
library(ggplot2)
library(GGally)

policy %>%
  select(PO_Age,INS_Age,Premium) %>%
  ggpairs()

policy %>%
  select(NumOfReinstated,NumOfClaims,NumOfEmails,NumOfCalls,AgentYearSVR) %>%
  ggpairs()
```

```{r}
# small function to display plots only if it's interactive
policy %>%
  select(PO_Age,INS_Age,Premium,PO_Sex) %>%
  ggpairs(columns = 1:3, 
          ggplot2::aes(colour=PO_Sex))

policy %>%
  select(PO_Age,INS_Age,Premium,PO_Sex) %>%
  ggpairs(ggplot2::aes(colour=PO_Sex))
```

```{r}
policy %>%
  select(PO_Age,INS_Age,Premium) %>%
  ggcorr()
```


## Feature Engineering

## Build models

## Evaluate and Finalize model


## Reference

More reference with ggpair https://ggobi.github.io/ggally/reference/ggpairs.html
